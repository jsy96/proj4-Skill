<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•å½±åæ ‡è½¬æ¢å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            color: #4fc3f7;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #b0bec5;
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.15);
            color: #fff;
            font-size: 1rem;
        }

        select option {
            background: #1a1a2e;
            color: #fff;
        }

        select:focus, input:focus {
            outline: 2px solid #4fc3f7;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.15);
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 80px;
        }

        .coord-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .coord-inputs.three {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79,195,247,0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: #fff;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76,175,80,0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            color: #1a1a2e;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,167,38,0.4);
        }

        .result-box {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            min-height: 60px;
        }

        .result-label {
            font-size: 0.85rem;
            color: #4fc3f7;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 1.1rem;
            font-weight: 600;
            word-break: break-all;
        }

        .conversion-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .conversion-type button {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            color: #b0bec5;
        }

        .conversion-type button.active {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: #1a1a2e;
        }

        .hidden {
            display: none;
        }

        .ecef-panel {
            margin-top: 20px;
        }

        .info-badge {
            display: inline-block;
            background: rgba(79,195,247,0.2);
            color: #4fc3f7;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ æŠ•å½±åæ ‡è½¬æ¢å·¥å…·</h1>

        <div class="main-grid">
            <!-- æºåæ ‡ç³»é¢æ¿ -->
            <div class="panel">
                <h2 class="panel-title">æºåæ ‡ç³»</h2>

                <div class="conversion-type">
                    <button id="srcPresetBtn" class="active" onclick="toggleSrcMode('preset')">é¢„è®¾æŠ•å½±</button>
                    <button id="srcCustomBtn" onclick="toggleSrcMode('custom')">è‡ªå®šä¹‰</button>
                </div>

                <div id="srcPresetArea">
                    <div class="form-group">
                        <label>é€‰æ‹©æŠ•å½±ç±»å‹</label>
                        <select id="srcProjection" onchange="updateSrcInfo()">
                            <option value="EPSG:4326">EPSG:4326 - WGS84 ç»çº¬åº¦åæ ‡</option>
                            <option value="EPSG:3857">EPSG:3857 - Web Mercator (è°·æ­Œåœ°å›¾)</option>
                            <option value="EPSG:4490">EPSG:4490 - CGCS2000 ç»çº¬åº¦</option>
                            <option value="EPSG:4544">EPSG:4544 - CGCS2000 / 3-degree Gauss-Kruger CM 120E</option>
                            <option value="EPSG:4545">EPSG:4545 - CGCS2000 / 3-degree Gauss-Kruger CM 121E</option>
                            <option value="EPSG:4546">EPSG:4546 - CGCS2000 / 3-degree Gauss-Kruger CM 122E</option>
                            <option value="EPSG:4547">EPSG:4547 - CGCS2000 / 3-degree Gauss-Kruger CM 123E</option>
                            <option value="EPSG:4214">EPSG:4214 - Beijing 1954</option>
                            <option value="EPSG:4480">EPSG:4480 - Xian 1980</option>
                            <option value="EPSG:2437">EPSG:2437 - Beijing 1954 / 3-degree GK CM 120E</option>
                            <option value="EPSG:2438">EPSG:2438 - Beijing 1954 / 3-degree GK CM 121E</option>
                            <option value="EPSG:2385">EPSG:2385 - Xian 1980 / 3-degree GK CM 120E</option>
                            <option value="EPSG:2386">EPSG:2386 - Xian 1980 / 3-degree GK CM 121E</option>
                            <option value="EPSG:2154">EPSG:2154 - Lambert 93 (æ³•å›½)</option>
                            <option value="EPSG:32650">EPSG:32650 - UTM Zone 50N</option>
                            <option value="EPSG:32651">EPSG:32651 - UTM Zone 51N</option>
                            <option value="EPSG:32652">EPSG:32652 - UTM Zone 52N</option>
                            <option value="EPSG:3395">EPSG:3395 - World Mercator</option>
                            <option value="EPSG:2154">EPSG:2154 - Lambert Conformal Conic</option>
                            <option value="EPSG:3035">EPSG:3035 - LAEA Europe</option>
                        </select>
                        <div id="srcInfo" class="info-badge">WGS84 ç»çº¬åº¦: (ç»åº¦, çº¬åº¦)</div>
                    </div>
                </div>

                <div id="srcCustomArea" class="hidden">
                    <div class="form-group">
                        <label>æŠ•å½±åç§° (EPSGä»£ç æˆ–è‡ªå®šä¹‰åç§°)</label>
                        <input type="text" id="srcCustomName" placeholder="ä¾‹å¦‚: EPSG:XXXX æˆ– my-proj">
                    </div>
                    <div class="form-group">
                        <label>Proj4 å®šä¹‰å‚æ•°</label>
                        <textarea id="srcCustomDef" placeholder="+proj=longlat +datum=WGS84 +no_defs"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¾“å…¥åæ ‡å€¼</label>
                    <div id="srcCoordInputs" class="coord-inputs">
                        <input type="number" id="srcX" placeholder="ç»åº¦ / X" step="any">
                        <input type="number" id="srcY" placeholder="çº¬åº¦ / Y" step="any">
                    </div>
                </div>
            </div>

            <!-- ç›®æ ‡åæ ‡ç³»é¢æ¿ -->
            <div class="panel">
                <h2 class="panel-title">ç›®æ ‡åæ ‡ç³»</h2>

                <div class="conversion-type">
                    <button id="dstPresetBtn" class="active" onclick="toggleDstMode('preset')">é¢„è®¾æŠ•å½±</button>
                    <button id="dstCustomBtn" onclick="toggleDstMode('custom')">è‡ªå®šä¹‰</button>
                </div>

                <div id="dstPresetArea">
                    <div class="form-group">
                        <label>é€‰æ‹©æŠ•å½±ç±»å‹</label>
                        <select id="dstProjection" onchange="updateDstInfo()">
                            <option value="EPSG:3857">EPSG:3857 - Web Mercator (è°·æ­Œåœ°å›¾)</option>
                            <option value="EPSG:4326">EPSG:4326 - WGS84 ç»çº¬åº¦åæ ‡</option>
                            <option value="EPSG:4490">EPSG:4490 - CGCS2000 ç»çº¬åº¦</option>
                            <option value="EPSG:4544">EPSG:4544 - CGCS2000 / 3-degree Gauss-Kruger CM 120E</option>
                            <option value="EPSG:4545">EPSG:4545 - CGCS2000 / 3-degree Gauss-Kruger CM 121E</option>
                            <option value="EPSG:4546">EPSG:4546 - CGCS2000 / 3-degree Gauss-Kruger CM 122E</option>
                            <option value="EPSG:4547">EPSG:4547 - CGCS2000 / 3-degree Gauss-Kruger CM 123E</option>
                            <option value="EPSG:4214">EPSG:4214 - Beijing 1954</option>
                            <option value="EPSG:4480">EPSG:4480 - Xian 1980</option>
                            <option value="EPSG:2437">EPSG:2437 - Beijing 1954 / 3-degree GK CM 120E</option>
                            <option value="EPSG:2438">EPSG:2438 - Beijing 1954 / 3-degree GK CM 121E</option>
                            <option value="EPSG:2385">EPSG:2385 - Xian 1980 / 3-degree GK CM 120E</option>
                            <option value="EPSG:2386">EPSG:2386 - Xian 1980 / 3-degree GK CM 121E</option>
                            <option value="EPSG:2154">EPSG:2154 - Lambert 93 (æ³•å›½)</option>
                            <option value="EPSG:32650">EPSG:32650 - UTM Zone 50N</option>
                            <option value="EPSG:32651">EPSG:32651 - UTM Zone 51N</option>
                            <option value="EPSG:32652">EPSG:32652 - UTM Zone 52N</option>
                            <option value="EPSG:3395">EPSG:3395 - World Mercator</option>
                            <option value="EPSG:3035">EPSG:3035 - LAEA Europe</option>
                        </select>
                        <div id="dstInfo" class="info-badge">Web Mercator: (X, Y) ç±³</div>
                    </div>
                </div>

                <div id="dstCustomArea" class="hidden">
                    <div class="form-group">
                        <label>æŠ•å½±åç§° (EPSGä»£ç æˆ–è‡ªå®šä¹‰åç§°)</label>
                        <input type="text" id="dstCustomName" placeholder="ä¾‹å¦‚: EPSG:XXXX æˆ– my-proj">
                    </div>
                    <div class="form-group">
                        <label>Proj4 å®šä¹‰å‚æ•°</label>
                        <textarea id="dstCustomDef" placeholder="+proj=merc +datum=WGS84 +no_defs"></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn-primary" onclick="convertCoordinate()">è½¬æ¢åæ ‡</button>
                    <button class="btn-warning" onclick="swapProjections()">äº¤æ¢</button>
                </div>

                <div class="result-box">
                    <div class="result-label">è½¬æ¢ç»“æœ</div>
                    <div id="resultValue" class="result-value">è¯·è¾“å…¥åæ ‡å€¼åç‚¹å‡»è½¬æ¢</div>
                </div>
            </div>
        </div>

        <!-- åœ°å¿ƒç›´è§’åæ ‡é¢æ¿ -->
        <div class="panel ecef-panel">
            <h2 class="panel-title">åœ°å¿ƒç›´è§’åæ ‡ (ECEF - Earth-Centered Earth-Fixed)</h2>
            <p style="color: #b0bec5; margin-bottom: 15px; font-size: 0.9rem;">
                åœ°å¿ƒç›´è§’åæ ‡ç³»ï¼šä»¥åœ°çƒè´¨å¿ƒä¸ºåŸç‚¹ï¼ŒXè½´æŒ‡å‘æœ¬åˆå­åˆçº¿ä¸èµ¤é“äº¤ç‚¹ï¼ŒZè½´æŒ‡å‘åŒ—æï¼ŒYè½´ä¸Xã€Zè½´æ„æˆå³æ‰‹åæ ‡ç³»ã€‚
            </p>

            <div class="main-grid">
                <div>
                    <div class="form-group">
                        <label>è¾“å…¥ç»çº¬åº¦ (åº¦) å’Œ é«˜ç¨‹ (ç±³)</label>
                        <div class="coord-inputs three">
                            <input type="number" id="ecefLon" placeholder="ç»åº¦" step="any" value="116.3912">
                            <input type="number" id="ecefLat" placeholder="çº¬åº¦" step="any" value="39.9075">
                            <input type="number" id="ecefHeight" placeholder="é«˜ç¨‹" step="any" value="50">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="convertToECEF()" style="width: 100%;">ç»çº¬åº¦ â†’ åœ°å¿ƒåæ ‡ (æ­£ç®—)</button>

                    <div class="result-box">
                        <div class="result-label">åœ°å¿ƒåæ ‡ (X, Y, Z) ç±³</div>
                        <div id="ecefResult" class="result-value">-</div>
                    </div>
                </div>

                <div>
                    <div class="form-group">
                        <label>è¾“å…¥åœ°å¿ƒåæ ‡ (X, Y, Z) ç±³</label>
                        <div class="coord-inputs three">
                            <input type="number" id="xyzX" placeholder="X" step="any">
                            <input type="number" id="xyzY" placeholder="Y" step="any">
                            <input type="number" id="xyzZ" placeholder="Z" step="any">
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="convertFromECEF()" style="width: 100%;">åœ°å¿ƒåæ ‡ â†’ ç»çº¬åº¦ (åç®—)</button>

                    <div class="result-box">
                        <div class="result-label">ç»çº¬åº¦ (ç»åº¦, çº¬åº¦) å’Œ é«˜ç¨‹ (ç±³)</div>
                        <div id="llhResult" class="result-value">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è½¬æ¢å†å² -->
        <div class="panel" style="margin-top: 20px;">
            <h2 class="panel-title">è½¬æ¢å†å²</h2>
            <div id="history" class="result-box" style="max-height: 200px; overflow-y: auto;">
                <div class="result-value" style="font-size: 0.9rem; color: #b0bec5;">æš‚æ— è½¬æ¢è®°å½•</div>
            </div>
            <button class="btn-warning" onclick="clearHistory()" style="margin-top: 10px;">æ¸…ç©ºå†å²</button>
        </div>
    </div>

    <script>
        // WGS84 æ¤­çƒå‚æ•°
        const WGS84_A = 6378137.0;  // é•¿åŠè½´
        const WGS84_F = 1 / 298.257223563;  // æ‰ç‡
        const WGS84_E2 = 2 * WGS84_F - WGS84_F * WGS84_F;  // ç¬¬ä¸€åå¿ƒç‡å¹³æ–¹

        // æ³¨å†Œå¸¸ç”¨æŠ•å½±å®šä¹‰
        function registerProjections() {
            // CGCS2000 (ä¸­å›½å¤§åœ°åæ ‡ç³»2000)
            proj4.defs('EPSG:4490', '+proj=longlat +ellps=GRS80 +no_defs');
            proj4.defs('EPSG:4544', '+proj=tmerc +lat_0=0 +lon_0=120 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs');
            proj4.defs('EPSG:4545', '+proj=tmerc +lat_0=0 +lon_0=121 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs');
            proj4.defs('EPSG:4546', '+proj=tmerc +lat_0=0 +lon_0=122 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs');
            proj4.defs('EPSG:4547', '+proj=tmerc +lat_0=0 +lon_0=123 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs');

            // Beijing 1954
            proj4.defs('EPSG:4214', '+proj=longlat +ellps=krass +towgs84=15.8,-154.4,-82.3,0,0,0,0 +no_defs');
            proj4.defs('EPSG:2437', '+proj=tmerc +lat_0=0 +lon_0=120 +k=1 +x_0=500000 +y_0=0 +ellps=krass +towgs84=15.8,-154.4,-82.3,0,0,0,0 +units=m +no_defs');
            proj4.defs('EPSG:2438', '+proj=tmerc +lat_0=0 +lon_0=121 +k=1 +x_0=500000 +y_0=0 +ellps=krass +towgs84=15.8,-154.4,-82.3,0,0,0,0 +units=m +no_defs');

            // Xian 1980
            proj4.defs('EPSG:4480', '+proj=longlat +ellps=IAU76 +towgs84=25,-147,-106,0,0,0,0 +no_defs');
            proj4.defs('EPSG:2385', '+proj=tmerc +lat_0=0 +lon_0=120 +k=1 +x_0=500000 +y_0=0 +ellps=IAU76 +towgs84=25,-147,-106,0,0,0,0 +units=m +no_defs');
            proj4.defs('EPSG:2386', '+proj=tmerc +lat_0=0 +lon_0=121 +k=1 +x_0=500000 +y_0=0 +ellps=IAU76 +towgs84=25,-147,-106,0,0,0,0 +units=m +no_defs');

            // UTM zones
            proj4.defs('EPSG:32650', '+proj=utm +zone=50 +datum=WGS84 +units=m +no_defs');
            proj4.defs('EPSG:32651', '+proj=utm +zone=51 +datum=WGS84 +units=m +no_defs');
            proj4.defs('EPSG:32652', '+proj=utm +zone=52 +datum=WGS84 +units=m +no_defs');
        }

        // æŠ•å½±ä¿¡æ¯æ˜ å°„
        const projectionInfo = {
            'EPSG:4326': 'WGS84 ç»çº¬åº¦: (ç»åº¦, çº¬åº¦)',
            'EPSG:3857': 'Web Mercator: (X, Y) ç±³',
            'EPSG:4490': 'CGCS2000 ç»çº¬åº¦: (ç»åº¦, çº¬åº¦)',
            'EPSG:4544': 'CGCS2000 3åº¦å¸¦ 120E: (X, Y) ç±³',
            'EPSG:4545': 'CGCS2000 3åº¦å¸¦ 121E: (X, Y) ç±³',
            'EPSG:4546': 'CGCS2000 3åº¦å¸¦ 122E: (X, Y) ç±³',
            'EPSG:4547': 'CGCS2000 3åº¦å¸¦ 123E: (X, Y) ç±³',
            'EPSG:4214': 'Beijing 1954 ç»çº¬åº¦: (ç»åº¦, çº¬åº¦)',
            'EPSG:4480': 'Xian 1980 ç»çº¬åº¦: (ç»åº¦, çº¬åº¦)',
            'EPSG:2437': 'Beijing 1954 3åº¦å¸¦ 120E: (X, Y) ç±³',
            'EPSG:2438': 'Beijing 1954 3åº¦å¸¦ 121E: (X, Y) ç±³',
            'EPSG:2385': 'Xian 1980 3åº¦å¸¦ 120E: (X, Y) ç±³',
            'EPSG:2386': 'Xian 1980 3åº¦å¸¦ 121E: (X, Y) ç±³',
            'EPSG:2154': 'Lambert 93 (æ³•å›½): (X, Y) ç±³',
            'EPSG:32650': 'UTM Zone 50N: (Easting, Northing) ç±³',
            'EPSG:32651': 'UTM Zone 51N: (Easting, Northing) ç±³',
            'EPSG:32652': 'UTM Zone 52N: (Easting, Northing) ç±³',
            'EPSG:3395': 'World Mercator: (X, Y) ç±³',
            'EPSG:3035': 'LAEA Europe: (X, Y) ç±³'
        };

        let conversionHistory = [];

        // åˆ‡æ¢æºåæ ‡æ¨¡å¼
        function toggleSrcMode(mode) {
            document.getElementById('srcPresetBtn').classList.toggle('active', mode === 'preset');
            document.getElementById('srcCustomBtn').classList.toggle('active', mode === 'custom');
            document.getElementById('srcPresetArea').classList.toggle('hidden', mode === 'custom');
            document.getElementById('srcCustomArea').classList.toggle('hidden', mode === 'preset');
        }

        // åˆ‡æ¢ç›®æ ‡åæ ‡æ¨¡å¼
        function toggleDstMode(mode) {
            document.getElementById('dstPresetBtn').classList.toggle('active', mode === 'preset');
            document.getElementById('dstCustomBtn').classList.toggle('active', mode === 'custom');
            document.getElementById('dstPresetArea').classList.toggle('hidden', mode === 'custom');
            document.getElementById('dstCustomArea').classList.toggle('hidden', mode === 'preset');
        }

        // æ›´æ–°æºåæ ‡ä¿¡æ¯
        function updateSrcInfo() {
            const proj = document.getElementById('srcProjection').value;
            document.getElementById('srcInfo').textContent = projectionInfo[proj] || proj;
        }

        // æ›´æ–°ç›®æ ‡åæ ‡ä¿¡æ¯
        function updateDstInfo() {
            const proj = document.getElementById('dstProjection').value;
            document.getElementById('dstInfo').textContent = projectionInfo[proj] || proj;
        }

        // è·å–æºåæ ‡å®šä¹‰
        function getSrcProjection() {
            if (!document.getElementById('srcCustomArea').classList.contains('hidden')) {
                const name = document.getElementById('srcCustomName').value.trim() || 'custom-src';
                const def = document.getElementById('srcCustomDef').value.trim();
                if (!def) {
                    throw new Error('è¯·è¾“å…¥è‡ªå®šä¹‰æŠ•å½±å®šä¹‰');
                }
                proj4.defs(name, def);
                return name;
            }
            return document.getElementById('srcProjection').value;
        }

        // è·å–ç›®æ ‡åæ ‡å®šä¹‰
        function getDstProjection() {
            if (!document.getElementById('dstCustomArea').classList.contains('hidden')) {
                const name = document.getElementById('dstCustomName').value.trim() || 'custom-dst';
                const def = document.getElementById('dstCustomDef').value.trim();
                if (!def) {
                    throw new Error('è¯·è¾“å…¥è‡ªå®šä¹‰æŠ•å½±å®šä¹‰');
                }
                proj4.defs(name, def);
                return name;
            }
            return document.getElementById('dstProjection').value;
        }

        // è½¬æ¢åæ ‡
        function convertCoordinate() {
            try {
                const srcProj = getSrcProjection();
                const dstProj = getDstProjection();
                const x = parseFloat(document.getElementById('srcX').value);
                const y = parseFloat(document.getElementById('srcY').value);

                if (isNaN(x) || isNaN(y)) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„åæ ‡å€¼');
                }

                const result = proj4(srcProj, dstProj, [x, y]);
                const resultStr = `X: ${result[0].toFixed(4)}, Y: ${result[1].toFixed(4)}`;
                document.getElementById('resultValue').textContent = resultStr;

                // æ·»åŠ åˆ°å†å²è®°å½•
                addToHistory(`${srcProj} â†’ ${dstProj}`, `(${x}, ${y})`, resultStr);

            } catch (error) {
                document.getElementById('resultValue').textContent = 'é”™è¯¯: ' + error.message;
            }
        }

        // äº¤æ¢æŠ•å½±
        function swapProjections() {
            // äº¤æ¢ä¸‹æ‹‰é€‰æ‹©
            const srcSelect = document.getElementById('srcProjection');
            const dstSelect = document.getElementById('dstProjection');
            const tempValue = srcSelect.value;
            srcSelect.value = dstSelect.value;
            dstSelect.value = tempValue;

            // äº¤æ¢åæ ‡å€¼
            const srcX = document.getElementById('srcX').value;
            const srcY = document.getElementById('srcY').value;
            const resultText = document.getElementById('resultValue').textContent;

            if (resultText && !resultText.includes('é”™è¯¯') && resultText !== 'è¯·è¾“å…¥åæ ‡å€¼åç‚¹å‡»è½¬æ¢') {
                const match = resultText.match(/X:\s*([\d.-]+),\s*Y:\s*([\d.-]+)/);
                if (match) {
                    document.getElementById('srcX').value = match[1];
                    document.getElementById('srcY').value = match[2];
                    document.getElementById('resultValue').textContent = `(${srcX}, ${srcY})`;
                }
            }

            updateSrcInfo();
            updateDstInfo();
        }

        // ç»çº¬åº¦è½¬åœ°å¿ƒåæ ‡ (ECEF)
        function convertToECEF() {
            const lon = parseFloat(document.getElementById('ecefLon').value) * Math.PI / 180;
            const lat = parseFloat(document.getElementById('ecefLat').value) * Math.PI / 180;
            const h = parseFloat(document.getElementById('ecefHeight').value) || 0;

            if (isNaN(lon) || isNaN(lat)) {
                document.getElementById('ecefResult').textContent = 'é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦';
                return;
            }

            const N = WGS84_A / Math.sqrt(1 - WGS84_E2 * Math.sin(lat) * Math.sin(lat));

            const X = (N + h) * Math.cos(lat) * Math.cos(lon);
            const Y = (N + h) * Math.cos(lat) * Math.sin(lon);
            const Z = (N * (1 - WGS84_E2) + h) * Math.sin(lat);

            const result = `X: ${X.toFixed(4)} m, Y: ${Y.toFixed(4)} m, Z: ${Z.toFixed(4)} m`;
            document.getElementById('ecefResult').textContent = result;

            // å¡«å……åˆ°åç®—è¾“å…¥æ¡†
            document.getElementById('xyzX').value = X.toFixed(4);
            document.getElementById('xyzY').value = Y.toFixed(4);
            document.getElementById('xyzZ').value = Z.toFixed(4);

            addToHistory('ç»çº¬åº¦ â†’ ECEF', `(${document.getElementById('ecefLon').value}Â°, ${document.getElementById('ecefLat').value}Â°, ${h}m)`, result);
        }

        // åœ°å¿ƒåæ ‡è½¬ç»çº¬åº¦ (ECEF â†’ LLH)
        function convertFromECEF() {
            const X = parseFloat(document.getElementById('xyzX').value);
            const Y = parseFloat(document.getElementById('xyzY').value);
            const Z = parseFloat(document.getElementById('xyzZ').value);

            if (isNaN(X) || isNaN(Y) || isNaN(Z)) {
                document.getElementById('llhResult').textContent = 'é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„ XYZ åæ ‡';
                return;
            }

            const p = Math.sqrt(X * X + Y * Y);
            const e2 = WGS84_E2;
            const a = WGS84_A;

            // åˆå§‹ä¼°è®¡
            let lat = Math.atan2(Z, p * (1 - e2));
            let N, lat_new, h;

            // è¿­ä»£è®¡ç®—çº¬åº¦
            for (let i = 0; i < 10; i++) {
                N = a / Math.sqrt(1 - e2 * Math.sin(lat) * Math.sin(lat));
                lat_new = Math.atan2(Z + e2 * N * Math.sin(lat), p);
                if (Math.abs(lat_new - lat) < 1e-12) break;
                lat = lat_new;
            }

            const lon = Math.atan2(Y, X);
            N = a / Math.sqrt(1 - e2 * Math.sin(lat) * Math.sin(lat));
            h = p / Math.cos(lat) - N;

            const lonDeg = lon * 180 / Math.PI;
            const latDeg = lat * 180 / Math.PI;

            const result = `ç»åº¦: ${lonDeg.toFixed(8)}Â°, çº¬åº¦: ${latDeg.toFixed(8)}Â°, é«˜ç¨‹: ${h.toFixed(4)} m`;
            document.getElementById('llhResult').textContent = result;

            // å¡«å……åˆ°æ­£ç®—è¾“å…¥æ¡†
            document.getElementById('ecefLon').value = lonDeg.toFixed(8);
            document.getElementById('ecefLat').value = latDeg.toFixed(8);
            document.getElementById('ecefHeight').value = h.toFixed(4);

            addToHistory('ECEF â†’ ç»çº¬åº¦', `(${X}m, ${Y}m, ${Z}m)`, result);
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(type, input, output) {
            const time = new Date().toLocaleTimeString();
            conversionHistory.unshift({ time, type, input, output });
            if (conversionHistory.length > 20) conversionHistory.pop();
            updateHistoryDisplay();
        }

        // æ›´æ–°å†å²æ˜¾ç¤º
        function updateHistoryDisplay() {
            const container = document.getElementById('history');
            if (conversionHistory.length === 0) {
                container.innerHTML = '<div class="result-value" style="font-size: 0.9rem; color: #b0bec5;">æš‚æ— è½¬æ¢è®°å½•</div>';
                return;
            }

            let html = '';
            conversionHistory.forEach(item => {
                html += `<div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem;">
                    <div style="color: #4fc3f7;">[${item.time}] ${item.type}</div>
                    <div style="color: #b0bec5;">è¾“å…¥: ${item.input}</div>
                    <div style="color: #fff;">è¾“å‡º: ${item.output}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // æ¸…ç©ºå†å²
        function clearHistory() {
            conversionHistory = [];
            updateHistoryDisplay();
        }

        // åˆå§‹åŒ–
        registerProjections();
        updateSrcInfo();
        updateDstInfo();
    </script>
</body>
</html>
